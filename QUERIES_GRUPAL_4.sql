-- Active: 1684982784502@@127.0.0.1@3306@telovendo_coins

CREATE DATABASE TELOVENDO_COINS;

USE TELOVENDO_COINS;

CREATE Table USER (
    ID_USER INT PRIMARY KEY,
    NAME_USER varchar(25)

);

CREATE TABLE ACCOUNT (
    ID_ACCOUNT INT PRIMARY KEY,
    ID_USER INT NOT NULL,
    TLV_COINS INT NOT NULL,
    FOREIGN KEY (ID_USER) REFERENCES USER (ID_USER) 

);

CREATE TABLE DATA_TRANSACTION ( 
    DATA_TRANSACTION INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    ID_USER INT NOT NULL,
    ID_ACCOUNT INT NOT NULL,
    FOREIGN KEY (ID_USER) REFERENCES USER(ID_USER),
    FOREIGN KEY (ID_ACCOUNT) REFERENCES ACCOUNT(ID_ACCOUNT) 
);


INSERT INTO USER (ID_USER,NAME_USER) VALUES 
(1,'Frank'),
(2,'Juan'),
(3,'Pedro'),
(4,'Maria');

-- CREATE 4 ACCOUNT
INSERT INTO ACCOUNT (ID_ACCOUNT,ID_USER,TLV_COINS) VALUES 
(1,1,400),
(2,2,400),
(3,3,500),
(4,4,400);

-- CREATE 4 DATA_TRANSACTION 
INSERT INTO DATA_TRANSACTION (DATA_TRANSACTION,ID_USER,ID_ACCOUNT) VALUES 
(1,1,1),
(2,2,2),
(3,3,3),
(4,4,4);



SET AUTOCOMMIT = 0 ;

START TRANSACTION;

SET @SALDO_TRANSFERIR := 200;
SELECT  `ID_USER` FROM ACCOUNT WHERE ID_USER = 1;
SET @VALOR_TRANSFERIDO := (SELECT `TLV_COINS` FROM ACCOUNT WHERE ID_USER = 1 AND `TLV_COINS` > 0 LIMIT 1);

UPDATE ACCOUNT SET TLV_COINS = (TLV_COINS + @SALDO_TRANSFERIR) WHERE ID_USER = 2;
UPDATE ACCOUNT SET TLV_COINS = IF(@VALOR_TRANSFERIDO > 0 , `TLV_COINS` - @SALDO_TRANSFERIR , `TLV_COINS`  ) WHERE ID_USER = 1;

ROLLBACK;

COMMIT;

SELECT * FROM ACCOUNT;



-- TRANSFERIR 150 DEL ID_USER 2 AL ID_USER 3 DESDE ACCOUNT

SET AUTOCOMMIT = 0 ;

START TRANSACTION;

SET @SALDO_TRANSFERIR := 150;
SELECT  `ID_USER` FROM ACCOUNT WHERE ID_USER = 2;
SET @VALOR_TRANSFERIDO := (SELECT `TLV_COINS` FROM ACCOUNT WHERE ID_USER = 2 AND `TLV_COINS` > 0 LIMIT 1);

UPDATE ACCOUNT SET TLV_COINS = (TLV_COINS + @VALOR_TRANSFERIDO) - @SALDO_TRANSFERIR WHERE ID_USER = 3;
UPDATE ACCOUNT SET TLV_COINS = (TLV_COINS - @SALDO_TRANSFERIR) WHERE ID_USER = 2;

ROLLBACK;

COMMIT;

SELECT * FROM ACCOUNT;


-- TRANSFERIR DEL USUARIO C AL USUARIO D


SET AUTOCOMMIT = 0 ;

START TRANSACTION;

SET @SALDO_TRANSFERIR := 500;
SELECT  `ID_USER` FROM ACCOUNT WHERE ID_USER = 3;
SET @VALOR_TRANSFERIDO := (SELECT `TLV_COINS` FROM ACCOUNT WHERE ID_USER = 3 AND `TLV_COINS` > 0 LIMIT 1);

UPDATE ACCOUNT SET TLV_COINS = (TLV_COINS + @SALDO_TRANSFERIR) WHERE ID_USER = 4;
UPDATE ACCOUNT SET TLV_COINS = IF (`TLV_COINS` > 0, `TLV_COINS` - @SALDO_TRANSFERIR , `TLV_COINS` ) WHERE ID_USER = 3;

COMMIT;

SELECT * FROM ACCOUNT;


--transferir del usuario 4 al usuario 1


SET AUTOCOMMIT = 0 ;

START TRANSACTION;

SET @SALDO_TRANSFERIR := 200;
SELECT  `ID_USER` FROM ACCOUNT WHERE ID_USER = 4;
SET @VALOR_TRANSFERIDO := (SELECT `TLV_COINS` FROM ACCOUNT WHERE ID_USER = 4 AND `TLV_COINS` > 0 LIMIT 1);

UPDATE ACCOUNT SET TLV_COINS = IF ( @VALOR_TRANSFERIDO > 0 , `TLV_COINS` + @SALDO_TRANSFERIR , `TLV_COINS`  )  WHERE ID_USER = 1;
UPDATE ACCOUNT SET TLV_COINS = IF (`TLV_COINS` > 0, `TLV_COINS` - @SALDO_TRANSFERIR , `TLV_COINS` ) WHERE ID_USER = 4;

COMMIT;

SELECT * FROM ACCOUNT;





